/*
 *
 * Wijmo Library 1.3.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijbarchart",a.wijmo.wijchartcore,{options:{horizontal:true,stacked:false,is100Percent:false,clusterOverlap:0,clusterWidth:85,clusterRadius:0,clusterSpacing:0,animation:{enabled:true,duration:400,easing:">"},seriesTransition:{enabled:true,duration:400,easing:">"},mouseDown:null,mouseUp:null,mouseOver:null,mouseOut:null,mouseMove:null,click:null},_create:function(){var d=["0-#8ac4c0-#77b3af","0-#73a19e-#67908e","0-#4f687b-#465d6e","0-#69475b-#5d3f51","0-#7a3b3f-#682e32","0-#9d5b5b-#8c5151","0-#e5a36d-#ce9262","0-#e6cc70-#ceb664","0-#8ec858-#7fb34f","0-#3a9073-#2a7b5f","0-#6c88e3-#6079cb","0-#6cb4e3-#60a0cb"],c=this,b=c.options;b.horizontal&&a.extend(true,b.axis,{x:{compass:"west"},y:{compass:"south"}});a.extend(true,{compass:"east"},b.hint);a.each(b.seriesStyles,function(b,a){if(!a.fill)a.fill=d[b]});a.wijmo.wijchartcore.prototype._create.apply(c,arguments);c.chartElement.addClass("wijmo-wijbarchart")},_setOption:function(c,b){c==="horizontal"&&!b&&a.extend(true,this.options.axis,{x:{compass:"south"},y:{compass:"west"}});a.wijmo.wijchartcore.prototype._setOption.apply(this,arguments)},destroy:function(){var b=this;b.chartElement.removeClass("wijmo-wijbarchart ui-helper-reset");a.wijmo.wijchartcore.prototype.destroy.apply(this,arguments);if(b.aniBarsAttr&&b.aniBarsAttr.length){a.each(b.aniBarsAttr,function(b,a){a=null});b.aniBarsAttr=null}},_isBarChart:function(){return true},getBar:function(a){return this.bars[a]},_adjustToLimits:function(a,c,b){return a<c?c:a>b?b:a},_transformPoints:function(c,d,e,f,g,b){a.each(b,function(j,a){var h=a.x,i=a.y,b=0;a.x=d*h+f;a.y=e*i+g;if(c){b=a.x;a.x=a.y;a.y=b}});return b},_paintPlotArea:function(){var a=this,c=a.options,b=c.horizontal,s=c.stacked,i=[].concat(c.seriesList),j=i.length,p=[].concat(c.seriesStyles.slice(0,j)),o=[].concat(c.seriesHoverStyles.slice(0,j)),g=a.canvasBounds,f={x:g.startX,y:g.startY},n=g.endX-f.x,k=g.endY-f.y,d=c.axis.x,e=c.axis.y,h,l=a._getScaling(b,d.max,d.min,b?k:n),m=a._getScaling(!b,e.max,e.min,b?n:k),q=a._getTranslation(b,f,d.max,d.min,l),r=a._getTranslation(!b,f,e.max,e.min,m);if(b&&!s){i.reverse();p.reverse();o.reverse()}if(j===0)return;h=a._paintClusters(i,p,o,{min:d.min,max:d.max,late:q,scale:l},{min:e.min,max:e.max,late:r,scale:m},n,k,f);a.chartElement.data("plotInfos",{xscale:l,xlate:q,yscale:m,ylate:r,rects:h.rects});a._playAnimation(h.animatedBars);a.bars=h.bars},_paintClusters:function(h,u,q,v,w,y,o,s){var c=this,e=c.options,j=e.stacked,b=e.clusterOverlap/100,t=e.clusterWidth/100,l=1,r=e.clusterSpacing+l,n=e.animation,x=n&&n.enabled,i=h.length,d,f,m=[],p=[],k=[],g=[];d=c._barPointList(h);if(j)d=c._stackValues(d);f=c._getMinDX(d)*t;if(i>1&&!j){b-=d.length*(i-1)*r/(e.horizontal?o:y);f/=i*(1-b)+b}a.each(d,function(r,y){var e=y.paSpec,z=e.length,n,t,i,d;if(j)n=f;else n=f*(z*(1-b)+b);t={x:y.x-n/2,y:0,width:f,height:e[0].y};a.each(e,function(f,y){if(!g[f])g[f]=[];var j=y.sIdx,n=u[j];d=c._paintBar(t,y.y,o,v,w,n,x,l,s,b,f>0?e[f-1].y:null,e[e.length-1].y);i=d.bar;c._addClass(a(i.node),"wijchart-canvas-object");a(i.node).data("wijchartDataObj",a.extend(true,{index:r,bar:i,type:"bar",style:n,hoverStyle:q[j]},h[j]));p.push(i);k.push(d.animatedBar);d.dcl&&m.push(d.dcl);g[f][r]=d.rect})});a.each(m,function(b,a){a.toFront()});return{bars:p,animatedBars:k,rects:g}},_paintBar:function(e,w,C,p,q,l,B,z,o,E,j,y){var i=this,n=i.options,G=n.stacked,F=n.is100Percent,x=n.horizontal,t=p.min,s=p.max,v=q.min,u=q.max,I=p.scale,K=p.late,J=q.scale,L=q.late,r,b,A,c,m=null,h,D=l,d=l["stroke-width"],H=l.stroke,g,f,k=i.canvas;if(G)if(F){if(y>0)e.height=w/y;if(j||j===0){e.y=j/y;e.height-=e.y}}else{e.height=w;if(j||j===0){e.height-=j;e.y=j}}else if(j||j===0){e.x+=e.width*(1-E);e.height=w}b=[{x:e.x,y:e.y},{x:e.x+e.width,y:e.y+e.height}];A=(t<=b[0].x&&b[0].x<=s||t<=b[1].x&&b[1].x<=s)&&(v<=b[0].y&&b[0].y<=u||v<=b[1].y&&b[1].y<=u);b[0].x=i._adjustToLimits(b[0].x,t,s);b[0].y=i._adjustToLimits(b[0].y,v,u);b[1].x=i._adjustToLimits(b[1].x,t,s);b[1].y=i._adjustToLimits(b[1].y,v,u);b=i._transformPoints(x,I,J,K,L,b);if(b[0].x>b[1].x){r=b[0].x;b[0].x=b[1].x;b[1].x=r}if(b[0].y>b[1].y){r=b[0].y;b[0].y=b[1].y;b[1].y=r}c={x:b[0].x,y:b[0].y,width:b[1].x-b[0].x,height:b[1].y-b[0].y};if(A){if(c.width===0)c.width=.5;if(c.height===0)c.height=.5}if(n.showChartLabels)m=i._paintDefaultChartLabel(c,w);h=l.r?l.r:n.clusterRadius;if(h)D=a.extend(true,{},l,{r:0});if(H!=="none"&&d)d=parseInt(d,10);if(!d||isNaN(d))d=0;if(B){if(h){if(x){g=k.wij.roundRect(c.x,c.y,c.width-d,c.height-d,0,0,h,h).hide();f=k.rect(o.x,c.y,0,c.height-d)}else{g=k.wij.roundRect(c.x,c.y,c.width-d,c.height-d,h,0,0,h).hide();f=k.rect(c.x,o.y+C-d,c.width,0)}i._paintShadow(f,z);f.wijAttr(D);f.bar=g}else{if(x)g=k.rect(o.x,c.y,0,c.height-d);else g=k.rect(c.x,o.y+C-d,c.width,0);f=g}if(m){m.attr({opacity:0});f.chartLabel=m}f.left=c.x;f.top=c.y;f.width=c.width-d;f.height=c.height-d;f.r=h}else if(h)g=k.wij.roundRect(c.x,c.y,c.width-d,c.height-d,0,0,h,h);else g=k.rect(c.x,c.y,c.width-d,c.height-d);i._paintShadow(g,z);B&&h&&g.shadow.hide();g.wijAttr(l);return{rect:c,dcl:m,animatedBar:f,bar:g}},_playAnimation:function(j){var b=this,h=b.options,c=h.animation,e=h.seriesTransition,f,g,i=[],d;if(c&&c.enabled){f=c.duration||2e3;g=c.easing||"linear";a.each(j,function(k,c){var j=h.horizontal?{width:c.width,x:c.left}:{height:c.height,y:c.top};if(b.aniBarsAttr&&e.enabled){d=b._getDiffAttrs(c.attr(),b.aniBarsAttr[k]);if(d.path)delete d.path;c.attr(d);f=e.duration;g=e.easing}i.push(a.extend(true,{},c.attr(),j));c.stop().wijAnimate(j,f,g,function(){var a=this,c=a.r,b=a;a.chartLabel&&a.chartLabel.wijAnimate({opacity:1},250);if(c){b=a.bar;b.show();b.shadow&&b.shadow.show();if(a.shadow){a.shadow.wijRemove();a.shadow=null}a.wijRemove();a=null}})});b.aniBarsAttr=i}},_paintDefaultChartLabel:function(b,k){var g=this,c=g.options,i=c.horizontal,j=a.extend(true,{},c.textStyle,c.chartLabelStyle),e=i?{x:b.x+b.width,y:b.y+b.height/2}:{x:b.x+b.width/2,y:b.y},f,d,h=g.round(k,2);if(c.chartLabelFormatString&&c.chartLabelFormatString.length)h=a.format(h,c.chartLabelFormatString);d=g._text(e.x,e.y,h).attr(j);f=d.getBBox();if(i)d.attr({x:e.x+f.width/2});else d.attr({y:e.y-f.height/2});return d},_getChartLabelPointPosition:function(k){var a=this,n=k.attachMethod,e=k.attachMethodData,g={x:0,y:0},b,f,i,c,d,j,m,h,l;switch(n){case"coordinate":g.x=e.x;g.y=e.y;break;case"dataCoordinate":b=a.chartElement.data("plotInfos");c=e.x;d=e.y;if(a._isDate(c))c=a._toOADate(c);if(a._isDate(d))d=a._toOADate(d);g=a._transformPoints(b.xscale,b.yscale,b.xlate,b.ylate,{x:c,y:d});break;case"dataIndex":f=e.seriesIndex;i=e.pointIndex;b=a.chartElement.data("plotInfos");if(f>-1){j=b.rects;if(j.length>f){m=j[f];h=m[i];g.x=h.x+h.width;g.y=h.y+h.height/2}}break;case"dataIndexY":f=e.seriesIndex;i=e.pointIndex;if(f>-1){l=a.options.seriesList[f].data;c=l.x[i];d=e.y;b=a.chartElement.data("plotInfos");if(a._isDate(c))c=a._toOADate(c);if(a._isDate(d))d=a._toOADate(d);g=a._transformPoints(b.xscale,b.yscale,b.xlate,b.ylate,{x:c,y:d})}}return g},_getTooltipText:function(h,g){var d=a(g.node).data("wijchartDataObj"),c=d.index,b=d.data,e,f,i;if(b.x){e=b.x[c];f=b.y[c]}else{e=b.xy[2*c];f=b.xy[2*c+1]}i={x:e,y:f,data:d,target:g,fmt:h};return a.proxy(h,i)()},_bindLiveEvents:function(){var b=this,g=b.options,h=g.hint.enable,d=b.tooltip,c,f,e;if(h&&!d){c=a.extend(true,{},g.hint);c.offsetY=c.offsetY||-2;f=c.title;e=c.content;if(a.isFunction(f))c.title=function(){return b._getTooltipText(f,this.target)};if(a.isFunction(e))c.content=function(){return b._getTooltipText(e,this.target)};c.beforeShowing=function(){if(this.target)this.options.style.stroke=this.target.attrs.stroke||this.target.attrs.fill};d=b.canvas.tooltip(b.bars,c);b.tooltip=d}a(".wijchart-canvas-object",b.chartElement[0]).live("mousedown.wijbarchart",function(c){b._trigger("mouseDown",c,a(c.target).data("wijchartDataObj"))}).live("mouseup.wijbarchart",function(c){b._trigger("mouseUp",c,a(c.target).data("wijchartDataObj"))}).live("mouseover.wijbarchart",function(c){b._trigger("mouseOver",c,a(c.target).data("wijchartDataObj"))}).live("mouseout.wijbarchart",function(f){var c=a(f.target).data("wijchartDataObj"),e=c.bar;b._trigger("mouseOut",f,c);if(!c.hoverStyle)e&&e.attr({opacity:"1"});else e.attr(c.style);d&&d.hide()}).live("mousemove.wijbarchart",function(e){var c=a(e.target).data("wijchartDataObj"),d=c.bar;b._trigger("mouseMove",e,c);if(!c.hoverStyle)d&&d.attr({opacity:"0.8"});else d.attr(c.hoverStyle)}).live("click.wijbarchart",function(c){b._trigger("click",c,a(c.target).data("wijchartDataObj"))})},_unbindLiveEvents:function(){var b=this;a(".wijchart-canvas-object",b.chartElement[0]).die("wijbarchart");if(b.tooltip){b.tooltip.destroy();b.tooltip=null}},_calculateParameters:function(c,e){a.wijmo.wijchartcore.prototype._calculateParameters.apply(this,arguments);if(c.id==="x"){var d=e.unitMinor,b=this._getBarAdjustment(c);if(b===0)b=d;else if(d<b&&d!==0)b=Math.floor(b/d)*d;c.min-=b;c.max+=b;this._calculateMajorMinor(e,c)}},_getBarAdjustment:function(c){for(var a=0,h=this.options,e=c.max,b=c.min,g=h.seriesList,f=0,d=0,f=0;f<g.length;f++){d=g[f].data.x.length;if(a<d)a=d}if(a>1)return(e-b)/a*h.clusterWidth*.0125;else if(a===1){if(b===0&&e===1){b=-1;c.min=b}return(e-b)*.0125}else return 0}});a.extend(a.wijmo.wijbarchart.prototype,{_barPointList:function(f){var b=[],d=this._getXSortedPoints;function c(b){this.x=b;this.paSpec=[];this.stackValues=function(){var c=this.paSpec.length,b;if(c>1){b=this.paSpec[0];a.each(this.paSpec,function(c,a){if(c===0)return true;a.y+=b.y;b=a})}}}function e(n,m){var h=d(m),l=m.length,f=null,o=0,e=0,g=0,k=true,i=0,j=false;if(h)o=h.length;if(b)g=b.length;a.each(h,function(d,a){if(k){k=false;i=a.x}else{if(i===a.x)j=true;else j=false;i=a.x}while(e<g&&b[e].x<a.x)e++;if(e<g)if(b[e].x!==a.x){f=new c(a.x,l);b.splice(e,0,f);g=b.length}else f=b[e];else{f=new c(a.x,l);b.push(f);g=b.length}f.paSpec.push({y:a.y,sIdx:n,pIdx:d,dupl:j})})}a.each(f,function(b,a){e(b,a)});return b},_getSpecWithValue:function(b){var c=null;a.each(b,function(d,a){if(a.x>=b){if(a.x===b)c=a;return false}});return c},_getMinDX:function(d){for(var a=Number.MAX_VALUE,e=d.length,c,b=1;b<e;b++){c=d[b].x-d[b-1].x;if(c<a&&c>0)a=c}return a===Number.MAX_VALUE?2:a},_stackValues:function(b){a.each(b,function(b,a){a.stackValues()});return b}})})(jQuery);